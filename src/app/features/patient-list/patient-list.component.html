<div class="p-4">
    <p-toast></p-toast>
    <p-card header="My Patients" subheader="Patients with active or past appointments">

        <p-table [value]="patients" [tableStyle]="{ 'min-width': '50rem' }">
            <ng-template pTemplate="header">
                <tr>
                    <th style="width: 50px"></th>
                    <th>Name</th>
                    <th>Last Visit</th>
                    <th>Total Appointments</th>
                    <th>Actions</th>
                </tr>
            </ng-template>
            <ng-template pTemplate="body" let-patient>
                <tr>
                    <td>
                        <p-avatar icon="pi pi-user" shape="circle" styleClass="bg-primary-100 text-primary"></p-avatar>
                    </td>
                    <td class="font-bold">{{ patient.name }}</td>
                    <td>{{ patient.lastVisit | date:'mediumDate' }}</td>
                    <td>{{ patient.totalAppts }}</td>
                    <td>
                        <p-button icon="pi pi-ellipsis-v" [rounded]="true" [text]="true"
                            (onClick)="showMenu($event, patient)"></p-button>
                    </td>
                </tr>
            </ng-template>
            <ng-template pTemplate="emptymessage">
                <tr>
                    <td colspan="5" class="text-center p-4">
                        <span class="text-500">No patients found. Appointments usually link patients to you.</span>
                    </td>
                </tr>
            </ng-template>
        </p-table>

    </p-card>

    <p-menu #menu [model]="menuItems" [popup]="true" appendTo="body"></p-menu>

    <!-- PATIENT DETAILS DIALOG -->
    <p-dialog [(visible)]="displayPatientDialog" [header]="selectedPatient?.name" [modal]="true"
        [style]="{width: '600px'}">
        <div class="flex flex-column gap-3" *ngIf="selectedPatientDetails">

            <div class="grid">
                <!-- Column 1: Profile -->
                <div class="col-6">
                    <h4 class="mt-0 mb-3 text-500">Profile</h4>
                    <div class="grid">
                        <div class="col-4 font-bold">Age:</div>
                        <div class="col-8">{{ selectedPatientDetails.age || '-' }}</div>

                        <div class="col-4 font-bold">Gender:</div>
                        <div class="col-8">{{ selectedPatientDetails.gender }}</div>

                        <div class="col-4 font-bold">Email:</div>
                        <div class="col-8" style="word-break: break-all;">{{ selectedPatientDetails.email }}</div>
                    </div>
                </div>

                <!-- Column 2: Latest Vitals (Fetched from History) -->
                <div class="col-6 border-left-1 surface-border pl-3">
                    <h4 class="mt-0 mb-3 text-500">Latest Vitals</h4>
                    <div class="grid" *ngIf="latestVital; else noVitals">
                        <div class="col-5 font-bold">Height:</div>
                        <div class="col-7">{{ latestVital.height || '-' }} cm</div>

                        <div class="col-5 font-bold">Weight:</div>
                        <div class="col-7">{{ latestVital.weight || '-' }} kg</div>

                        <div class="col-5 font-bold">BP:</div>
                        <div class="col-7">
                            {{ latestVital.bloodPressureSys || '-' }}/{{ latestVital.bloodPressureDia || '-' }}
                        </div>

                        <div class="col-5 font-bold">Heart Rate:</div>
                        <div class="col-7">{{ latestVital.heartRate || '-' }} bpm</div>
                    </div>
                    <ng-template #noVitals>
                        <div class="text-500 font-italic">No vitals recorded.</div>
                    </ng-template>
                </div>
            </div>

        </div>
        <ng-template pTemplate="footer">
            <p-button label="Close" icon="pi pi-times" (onClick)="displayPatientDialog = false"></p-button>
        </ng-template>
    </p-dialog>
</div>